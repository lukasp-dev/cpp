### IP

#### IPv4
![image](https://cdn.kastatic.org/ka-perseus-images/337190cba133e19ee9d8b5878453f915971a59cd.svg)
IPv4 Packet
- **IP Header** (위에 보이는 ver, TL, fragment, checksum, src/dst IP 등)
- **Payload** (TCP/UDP segment 같은 실제 데이터)

#### TCP Segment Header
![image](https://cdn.kastatic.org/ka-perseus-images/e5fdf560fdb40a1c0b3c3ce96f570e5f00fff161.svg)
- TCP가 L4에서 만들어내는 데이터 단위
- 신뢰성 있는 데이터 전달을 위한 모든 제어 정보가 들어 있음
1. 데이터 순서 보장
    - sequence number
        - 내가 보낸 바이트의 번호
2. 수신 확인 (ACK)
    - Acknowledgement Number
3. 연결 제어 (3-way handshake, 4-way termination)
    - Flags 
        - SYN, ACK, FIN, RST, PSH, URG 등
4. 흐름 제어 
    - Window Size
        - 상대가 받을 수 있는 데이터 양
5. 오류 검사
    - Checksum
6. 포트 번호로 application 구분
    - Source Port/Destination Port

#### OSI 7-layer
![image](https://d2cest1yk6hx2d.cloudfront.net/uninets-001/store/3057/article%20images/osi-layers-image.png)

#### Encapsulated packets
-  각 계층의 데이터 단위가 아래 계층의 페이로드로 들어가면서 감싸지는 구조
1. TCP 세그먼트 (Layer 4-5)
    - TCP 헤더 + TCP 페이로드(예: HTTP request)
2. IP Packet (Layer 3)
    - IP header + IP payload(=entire TCP segment)
3. Ethernet Frame (Layer 2)
    - ethernet header + ethernet payload(=entire IP Packet) + ethernet Trailer
    - 0과1(물리게틍에서 전송되는 신호)들이 모여 만들어진 데이터 링크 계층의 전송 단위.
    - wireshark 같은 툴로 캡처하면 바로 이 프레임 단위로 보이게 됨.

#### IP Addressing
1. IPv4 주소 구조
    - 총 32비트, 즉 4 옥텟 = 4 바이트
    - 각 옷텟은 8비트(0~255) 범위의 10진수
    - 표기방식: dotted decimal(예:130.207.7.31)
    - 같은 주소를 16진수로 쓰면 `0x82CF071F`
2. 유효 범위
    - 각 숫자(옥텟)는 0~255 사이
    - 25를 넘는 값(예:257)은 유효하지 않은 IPv4 주소
3. 서브넷 마스크
    - IP 주소를 네트워크 부분과 호스트 부분으로 나누는 32비트 값
    - 앞쪽은 1, 뒤쪽은 0으로 구성
    (예: 255.255.255.0->11111111.11111111.11111111.00000000)
    - 마스크의 1이 있는 비트는 네트워크 식별자, 0이 있는 비트는 호스트 식별자
        - `255.0.0.0`->`/8`
        - `255.255.0.0`->`/16`
        - `255.255.255.0`->`/24`
    - 가능한 마스크는 0비트부터 32비트까지, 총 33가지(즉, `/0` ~ `/32`)
    - IP 주소와 마스크를 AND 연산하면 **네트워크 주소**가 나옴.
    - 예시:
        
        | 항목 | 값 |
        |------|------|
        | 입력 IP | 10.42.2.1/12 |
        | IP (2진수) | 0000 1010 0010 1010 0000 0010 0000 0001 |
        | 서브넷 마스크 (/12) | 1111 1111 1111 0000 0000 0000 0000 0000 |
        | Network 부분 | 10.32.0.0 |
        | Host 부분 | 0.10.2.1 |
    - If network bits from two addresses are equal, the two are on the same network
    - One the same network means the data layer will be used to deliver traf between the two addresses, not the network layer


#### Subnet and CIDR Notation
전통적 표기: `130.207.254.64 255.255.255.192`

CIDR 표기: `130.207.254.64/26`→ 둘 다 같은 네트워크를 의미함.
- CIDR 블록(`/26`)으로 묶으면 라우터가 개별 IP를 다 저장할 필요가 없음
- 여러 주소를 하나의 요약된 경로(prefix)로 표현 -> 라우팅 테이블 항목 수가 줄어듦
- 테이블이 작아지면 **검색 속도 증가, 메모리 사용 감소, 라우터 부하 감소**
- 전체 인터넷 라우팅(특히 BGP)에서 경로 수 폭발을 방지하는 핵심 메커니즘

#### What gets assigned an IP address
- IP 주소는 기기(device)가 아니라 "네트워크 연결 단위(interface)"에 부여된다. 그래서 노트북은 Wi-Fi용 IP와 유선 Ethernet IP를 따로 가질 수 있고, 라우터는 항상 여러 IP 주소를 가진다.
- To be able to participate on the internet, a computer just needs one network interface; that fives to the misconception that IP addresses are assigned to computers.

**Router**의 경우
- 여러 네트워크를 연결하므로 인터페이스가 여러개, 따라서 IP 주소도 여러 개를 가짐
- 중간에 라우터를 2개 지나면 2 hops 라고 한다.

#### Why Same-Network communication is faster
1. Same network -> Layer 2에서 바로 전달
- 같은 서브넷에 있으면 IP라우팅이 필요 없음 
- 스위치가 MAC 주소 기반으로 바로 전송
- 경로가 짧고 단순
2. Different network -> 라우터를 반드시 거침
- 라우팅 테이블 조회
- 패킷 전달 -> 다음 라우터 -> 또 라우팅 -> 또 목적지로 이동
- 중간 hop(라우터)마다 처리 비용 증가
- 결과적으로 느릴 수밖에 없음

If the network address part of hte interface address and destination addresses are the **same**, then

-> **Pass the packet to layer 2 for delivery**

If the network address part of hte interface address and destination addresses are the **different**, then

-> **Send the packet to the next-hop router by choosing the longest match in the IP routing table**

#### TCP 3-Way Handshake
TCP 는 신뢰성 있는 양방향 연결을 만들기 위해 연결을 시작할 때 3개의 패킷을 주고받는다.
![image](https://media.geeksforgeeks.org/wp-content/uploads/TCP-connection-1.png)

1. SYN
    - 클라이언트가 서버에 연결하고 싶다 요청
    - 초기 시퀀스 번호(ISN) 전달
2. SYN + ACK
    - 서버가 요청을 승인하고 응답
    - 서버 쪽 초기 시퀀스 번호(ISN)도 함꼐 전송
3. ACK
    - 클라이언트가 서버의 SYN을 확인했다는 응답
    - 이 시점에서 연결 확립

#### connection identifier
A TCP connection is uniquely identified by these four things:
```
Source IP, Source Port, Destination IP, Destination Port
```
- This 4-item set is called: **the 4-tuple** or **the socket pair**
- to sum up, A TCP connection is uniquely identified by the 4-tuple(socket pair).

#### TCP and UDP port numbers
- Port numbers are used to keep track of different conversations. Both source and destination port count.
- Well-know=n port numbers are traditionally from 1-1023.
- Numbers 10124 and above are dynamic (ephemeral) port numbers.
- Registered port numbers for vendor-specific applications are now allowed above 1024.

#### Why a Unique Source Port Is Required
- When multiple TCP connections target the **the same destination IP and port**, the only distinguishing field is source port.
- The TCP/IP stack therefore assigns a unique source port to each new connection, ensuring the 4-tuple. (source IP, source port, destination IP, destination port) is unique.
- This allows both the OS and the remote server to correctly identify which packets belong to which connection and route responses to the proper session.
**Q.**If the browser is running at 193.12.1.5, and the web server is offering service on port 80 at 130.207.7.13, how does TCP keep the conversations separate?
- The browser lets the TCP stack choose a unique source port number for each connection.

#### Stateful Firewall
- 방화벽은 미리 정의된 정책에 따라 트래픽을 허용하거나 차단.
    - 예: 
        - Inbound packet은 모두 차단.
        - Outbound packet은 모두 허용.
- 방화벽은 연결이 열릴 때마다 그 연결의 정보를 State Table 또는 Connection Table에 저장한다.
- 이 테이블에는 다은 정보가 들어간다:
    - 출발지 IP, 출발지 포트
    - 목적지 IP, 목적지 포트
    - 프로토콜(TCP/UDP 등)
- 방화벽은 들어오는 패킷을 먼저 Connection Table과 비교.
- 만역 해당 패킷이 기존에 기록된 연결의 응답이라면 자동으로 허용.

#### NAT(Network Address Translation)
| NAT Type                     | Description |
|-----------------------------|-------------|
| **Static One-to-One NAT**   | Permanent 1:1 mapping between an internal IP and a public IP. Address is always the same; checksums recalculated during translation. Used for servers needing fixed public access. |
| **Dynamic One-to-N NAT**    | Similar to static NAT but public IPs come from a pool. Assigned only when needed; returned after connection ends. Not suitable for hosting services. |
| **PAT (NAT Overload)**      | Many internal hosts share one public IP. Router uses different port numbers to distinguish connections. Most common NAT type (home/office routers). |
| **Port Forwarding (Static PAT)** | Maps a specific public port to a specific internal IP:port. Allows external devices to reach an internal server (e.g., web server, game server). |
| **NAT Reflection / Loopback** | Lets internal clients access an internal server using its public IP. Useful for consistent URLs inside/outside the network. |
| **Twice NAT (Bidirectional)** | Both source and destination addresses are translated. Used when IP ranges overlap or for complex enterprise networks. |

